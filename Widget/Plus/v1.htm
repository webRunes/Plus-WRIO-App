<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<template id="plus-plus-template">
    <li class="new panel active"><a href="#element4" data-parent="#nav-accordion" data-toggle="collapse">
        <span class="glyphicon glyphicon-plus"></span></a>
        <div class="collapse" id="element4"></div>
    </li>
</template>

<script>
    (function ($) {
        var webrunes = window.webrunes || {};
        var href = window.location.origin + window.location.pathname;
        var importDoc = document.currentScript.ownerDocument;

        var $template = $('<ul class="nav navbar-nav" id="nav-accordion"></ul>');
        var plus = importDoc.querySelector('#plus-plus-template');
        var $plus = $(plus.innerHTML);

        var proto = Object.create(HTMLElement.prototype);
        proto.createdCallback = function () {
            var self = this;
            var url = webrunes.plusUrl;
            if(url){
                this.getModel(url, function (model) {
                    for(var i = 0; i < model.length; i++){
                        var collapseCss = model[i].url == href ? '' : 'collapsed';
                        var activeCss = model[i].url == href ? 'active' : '';
                        var $box = $('<li class="panel"></li>');
                        $($box).addClass(activeCss);
                        var $title = $('<a href="#" data-parent="#nav-accordion" data-toggle="collapse"></a>').html(model[i].name);
                        $($title).attr('href', '#element' + (i + 1));
                        $($title).addClass(collapseCss);
                        $($box).append($title);

                        if(model[i].items.length > 0){
                            var $div = $('<div></div>');
                            $($div).attr('id', 'element' + (i + 1))
                            $($box).append($div);
                            var $ul = $('<ul class="nav nav-pills nav-stacked sub"></ul>');
                            $($div).append($ul);
                            $($div).addClass(model[i].url == href ? 'in' : 'collapse');

                            if (model[i].url == href) {
                                $($div).addClass('active');
                            }

                            for(var j = 0; j < model[i].items.length; j++){
                                var $li = $('<li><a href="#" class="pull-right"><span class="glyphicon glyphicon-remove"></span></a></li>');
                                var $item = $('<a href="#"></a>').html(model[i].items[j].name);
                                $($item).attr('href', model[i].items[j].url);
                                $($ul).append($li);
                                $($li).append($item);
                            }
                        }
                        $($template).append($box);
                    }

                        $($template).append($($plus));
                        self.outerHTML = $template.get(0).outerHTML;
                });
            }

        };
        proto.getModel = function (urlList, callback) {
            var self = this;
            $.get(urlList).success(function (response) {
                var $frame = $('<iframe id = "12345" style="display: none;"></iframe>');
                $('body').append($frame);
                var doc = $frame.get(0).contentWindow.document;
                doc.write(response);
                var jsons = $(doc).find('script[type="application/ld+json"]');
                var json = $(jsons[1]).html();
                $($frame).remove();

                if (json) json = JSON.parse(json);
                var models = self.createModel(json);
                if (callback) callback(models);
            }).error(function () {
                if (callback) callback([]);
            });
        };
        proto.createModel = function(json){
            if(!json) return [];
            var models = [];
            for(var i = 0; i < json.itemListElement.length; i++){
                if(!json.itemListElement[i].author){
                    var blogUrl = json.itemListElement[i].url;
                    var item = {name: json.itemListElement[i].name, url: json.itemListElement[i].url, items: []};
                    for(var j = 0; j < json.itemListElement.length; j++){
                        if(json.itemListElement[j].author && json.itemListElement[j].author == blogUrl){
                            var elem = {name: json.itemListElement[j].name, url: json.itemListElement[j].url};
                            item.items.push(elem);
                        }
                    }
                    models.push(item);
                }
            }
            return models;
        };
        document.registerElement('plus-widget', {prototype: proto});
    })(jQuery);
</script>